#!/usr/bin/env python

import argparse
import os
import sys

parser = argparse.ArgumentParser(description="process and geocode business registries")

parser.add_argument(
    "--year", "-y", type=int, required=True, help="""
        The year of the registry.""")
parser.add_argument(
    "--images", "-i", required=True, nargs='+', help="""
        Images to process.""")
parser.add_argument(
    "--config", "-c", help="""
        Path to the configuration file.""")
parser.add_argument(
    "--append", action="store_true", help="""
        Append to the output file instead of overwriting it.""")
parser.add_argument(
    "--debug", action="store_true", help="""
        Draw images showing intermediate output during processing.""")
parser.add_argument(
    "--pre-processed", action="store_true", help="""
        Assume images have been preprocessed by scan-tailor.""")
parser.add_argument(
    "--outdir", "-o", help="""
        Path to the directory to write out results.""")
parser.add_argument(
    "--state", "-s", default="", required=True, help="""
        US state to get city list.""")

args = parser.parse_args()

# import registry processor based on year
if args.state == "RI":
    if args.year > 1975:
        from georeg.registry_processor_new import RegistryProcessorNew as RegistryProcessor
    else:
        from georeg.registry_processor_old import RegistryProcessorOld as RegistryProcessor
elif args.state == "TX":
    if args.year > 1999:
        from georeg.registry_processor_TX_2000s import RegistryProcessorTX2000s as RegistryProcessor
    else: 
        from georeg.registry_processor_new_TX import RegistryProcessorNewTX as RegistryProcessor
else:
    raise ValueError("%s is not a supported state" % (args.state,))

reg_processor = RegistryProcessor(args.state)

if os.path.exists(args.config):
    reg_processor.load_settings_from_cfg(args.config)
else: print >>sys.stderr, "configuration file not found"
     
reg_processor.draw_debug_images = args.debug
reg_processor.assume_pre_processed = args.pre_processed

if args.append:
    mode = 'a'
else:
    mode = 'w'

outname = "%s/%d-compiled.tsv" % (args.outdir, args.year)

for image in args.images:
    print >>sys.stderr, "processing:", image
    reg_processor.process_image(image)
    reg_processor.record_to_tsv(outname, mode)
    if mode == 'w': mode = 'a'

print('\a')  #makes a noise at the end of the script.  May only work on Mac
print >>sys.stderr, "done"
